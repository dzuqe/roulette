from web3 import Web3
import os
from web3.middleware import geth_poa_middleware

#web3 = Web3(Web3.HTTPProvider('https://goerli.infura.io/v3/' + os.environ['INFURA_API_KEY']))
#web3 = Web3(Web3.HTTPProvider('https://speedy-nodes-nyc.moralis.io/09dd853d231566671a467e96/polygon/mainnet'))
web3 = Web3(Web3.HTTPProvider('https://speedy-nodes-nyc.moralis.io/09dd853d231566671a467e96/polygon/mumbai'))
web3.middleware_onion.inject(geth_poa_middleware, layer=0)
#web3 = Web3(Web3.HTTPProvider("http://127.0.0.1:8545"))

#me = web3.eth.accounts[0]
me = "0xc4192029059E1D3a522751cCFc3E2Bf7f3c1172e"

binary="60c06040523480156200001157600080fd5b5060405162000ea038038062000ea0833981810160405281019062000037919062000189565b83838173ffffffffffffffffffffffffffffffffffffffff1660a08173ffffffffffffffffffffffffffffffffffffffff1660601b815250508073ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff1660601b81525050505081600281905550806003819055506000805b600c811215620001385760005b6003811215620001215782600160008481526020019081526020016000206000838152602001908152602001600020819055508280620001089062000247565b9350508080620001189062000247565b915050620000c8565b5080806200012f9062000247565b915050620000bb565b50505050505062000312565b6000815190506200015581620002c4565b92915050565b6000815190506200016c81620002de565b92915050565b6000815190506200018381620002f8565b92915050565b60008060008060808587031215620001a057600080fd5b6000620001b08782880162000144565b9450506020620001c38782880162000144565b9350506040620001d6878288016200015b565b9250506060620001e98782880162000172565b91505092959194509250565b600062000202826200021d565b9050919050565b6000819050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000620002548262000213565b91507f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156200028a576200028962000295565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b620002cf81620001f5565b8114620002db57600080fd5b50565b620002e98162000209565b8114620002f557600080fd5b50565b62000303816200023d565b81146200030f57600080fd5b50565b60805160601c60a05160601c610b5b62000345600039600081816101670152610300015260006102c40152610b5b6000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80635ec01e4d1461005c57806382678dd61461007a57806394985ddd14610098578063c2b962fc146100b4578063ced72f87146100e4575b600080fd5b610064610102565b60405161007191906107e4565b60405180910390f35b61008261015b565b60405161008f91906107e4565b60405180910390f35b6100b260048036038101906100ad919061059f565b610165565b005b6100ce60048036038101906100c991906105db565b610201565b6040516100db919061086d565b60405180910390f35b6100ec6102b6565b6040516100f991906108e8565b60405180910390f35b60006101126002546003546102c0565b90503373ffffffffffffffffffffffffffffffffffffffff16817fe2b1f599dace2ec0aff47f34e46d0ef28d36f226d155d28382661461e584bf3d60405160405180910390a390565b6000600254905090565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146101f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101ea906108a8565b60405180910390fd5b6101fd828261041f565b5050565b600060038312610246576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161023d906108c8565b60405180910390fd5b600c8212610289576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161028090610888565b60405180910390fd5b60016000838152602001908152602001600020600084815260200190815260200160002054905092915050565b6000600354905090565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff16634000aea07f0000000000000000000000000000000000000000000000000000000000000000848660006040516020016103349291906107ff565b6040516020818303038152906040526040518463ffffffff1660e01b8152600401610361939291906107a6565b602060405180830381600087803b15801561037b57600080fd5b505af115801561038f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103b39190610576565b5060006103d584600030600080898152602001908152602001600020546104b3565b90506001600080868152602001908152602001600020546103f69190610930565b6000808681526020019081526020016000208190555061041684826104ef565b91505092915050565b600060016014836104309190610a29565b61043a9190610930565b905080600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555080837f1674c86822306a661bf4570502e6711ed5d1a014ef6e16bab96ed6b4b0142a1260405160405180910390a3505050565b6000848484846040516020016104cc9493929190610828565b6040516020818303038152906040528051906020012060001c9050949350505050565b6000828260405160200161050492919061077a565b60405160208183030381529060405280519060200120905092915050565b60008151905061053181610ac9565b92915050565b60008135905061054681610ae0565b92915050565b60008135905061055b81610af7565b92915050565b60008135905061057081610b0e565b92915050565b60006020828403121561058857600080fd5b600061059684828501610522565b91505092915050565b600080604083850312156105b257600080fd5b60006105c085828601610537565b92505060206105d185828601610561565b9150509250929050565b600080604083850312156105ee57600080fd5b60006105fc8582860161054c565b925050602061060d8582860161054c565b9150509250929050565b61062081610986565b82525050565b61062f816109a4565b82525050565b610646610641826109a4565b610a15565b82525050565b600061065782610903565b610661818561090e565b93506106718185602086016109e2565b61067a81610ab8565b840191505092915050565b61068e816109ae565b82525050565b60006106a1600a8361091f565b91507f7920746f6f2062696721000000000000000000000000000000000000000000006000830152602082019050919050565b60006106e1601f8361091f565b91507f4f6e6c7920565246436f6f7264696e61746f722063616e2066756c66696c6c006000830152602082019050919050565b6000610721600a8361091f565b91507f7820746f6f2062696721000000000000000000000000000000000000000000006000830152602082019050919050565b61075d816109d8565b82525050565b61077461076f826109d8565b610a1f565b82525050565b60006107868285610635565b6020820191506107968284610763565b6020820191508190509392505050565b60006060820190506107bb6000830186610617565b6107c86020830185610754565b81810360408301526107da818461064c565b9050949350505050565b60006020820190506107f96000830184610626565b92915050565b60006040820190506108146000830185610626565b6108216020830184610754565b9392505050565b600060808201905061083d6000830187610626565b61084a6020830186610754565b6108576040830185610617565b6108646060830184610754565b95945050505050565b60006020820190506108826000830184610685565b92915050565b600060208201905081810360008301526108a181610694565b9050919050565b600060208201905081810360008301526108c1816106d4565b9050919050565b600060208201905081810360008301526108e181610714565b9050919050565b60006020820190506108fd6000830184610754565b92915050565b600081519050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600061093b826109d8565b9150610946836109d8565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561097b5761097a610a5a565b5b828201905092915050565b6000610991826109b8565b9050919050565b60008115159050919050565b6000819050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b60005b83811015610a005780820151818401526020810190506109e5565b83811115610a0f576000848401525b50505050565b6000819050919050565b6000819050919050565b6000610a34826109d8565b9150610a3f836109d8565b925082610a4f57610a4e610a89565b5b828206905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000601f19601f8301169050919050565b610ad281610998565b8114610add57600080fd5b50565b610ae9816109a4565b8114610af457600080fd5b50565b610b00816109ae565b8114610b0b57600080fd5b50565b610b17816109d8565b8114610b2257600080fd5b5056fea264697066735822122061be9926c9487f8a8e14d9ea478224657c9eff496cada481cac0b59b379f939a64736f6c63430008000033"

abi='[{"inputs":[{"internalType":"address","name":"vrfCoordinator","type":"address"},{"internalType":"address","name":"link","type":"address"},{"internalType":"bytes32","name":"keyHash","type":"bytes32"},{"internalType":"uint256","name":"fee","type":"uint256"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"id","type":"bytes32"},{"indexed":true,"internalType":"address","name":"player","type":"address"}],"name":"NumberGen","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"id","type":"bytes32"},{"indexed":true,"internalType":"uint256","name":"value","type":"uint256"}],"name":"NumberResult","type":"event"},{"inputs":[{"internalType":"int256","name":"x","type":"int256"},{"internalType":"int256","name":"y","type":"int256"}],"name":"getBoard","outputs":[{"internalType":"int256","name":"","type":"int256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getKey","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"random","outputs":[{"internalType":"bytes32","name":"id","type":"bytes32"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"requestId","type":"bytes32"},{"internalType":"uint256","name":"randomness","type":"uint256"}],"name":"rawFulfillRandomness","outputs":[],"stateMutability":"nonpayable","type":"function"}]'

game = web3.eth.contract(abi=abi, bytecode=binary)

data = {
    "key_hash": "",
    "vrf_coord": "",
    "link_token": "",
    "fee": 0,
}

chain = "testnet"

if chain == "mainnet":
    data["key_hash"] = "0xf86195cf7690c55907b2b611ebb7343a6f649bff128701cc542f0569e2c549da"
    data["vrf_coord"] = "0x3d2341ADb2D31f1c5530cDC622016af293177AE0"
    data["link_token"] = "0xb0897686c545045aFc77CF20eC7A532E3120E0F1"
    data["fee"] = web3.toWei('0.0001', 'ether')
elif chain == "testnet":
    data["link_token"] = "0x326C977E6efc84E512bB9C30f76E30c160eD06FB"
    data["fee"] = web3.toWei('0.0001', 'ether')
    data["key_hash"] = "0x6e75b569a01ef56d18cab6a8e71e6600d6ce853834d4a5748b720d06f878b3a4"
    data["vrf_coord"] = "0x8C7382F9D8f56b33781fE506E897a4F1e2d17255"

print(data)

dtx = game.constructor(data["vrf_coord"], data["link_token"], data["key_hash"], data["fee"]).buildTransaction({
    'gas': 1200000,
    'gasPrice': web3.toWei(40, 'gwei'),
    'nonce': web3.eth.getTransactionCount(me),
    'chainId': web3.eth.chainId
})

stx = web3.eth.account.signTransaction(dtx, private_key='0xd178895f7bd6578caa9bfa4182824796b19d936d5a006831257aa2632158dbbe') #os.environ['ETHEREUM_PRIVATE_KEY'])
ret = web3.eth.sendRawTransaction(stx.rawTransaction)

print("result: ", ret.hex())

#disp = web3.eth.contract(address="0x8512934aEC06ee5f53877532B845C3425a60932A", abi=abi)

#bob = "0x4d3218B23D4f383dA54df6dDFf4833a9d36F75c3"
#alice = "0x4CcB5406869C76B18FFf8Ad8e3C73551C6Ee9944"
#harry = "0x6Be02d1d3665660d22FF9624b7BE0551ee1Ac91b"

#addresses = [bob, alice, harry]
#amounts = [web3.toWei(1, 'ether'),web3.toWei(5, 'ether'),web3.toWei(10, 'ether')]
#etx = disp.functions.disperseEther(addresses, amounts).buildTransaction({
#    'gas': 1000000,
#    'value': web3.toWei(20, 'ether'),
#    'gasPrice': web3.toWei(1, 'gwei'),
#    'nonce': web3.eth.getTransactionCount(me),
#    'chainId': web3.eth.chainId
#})
#
#setx = web3.eth.account.signTransaction(etx, private_key=os.environ['ETHEREUM_PRIVATE_KEY'])
#retx = web3.eth.sendRawTransaction(setx.rawTransaction)
#
